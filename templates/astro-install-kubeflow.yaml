AWSTemplateFormatVersion: "2010-09-09"
Description: "deploy an example workload into an existing kubernetes cluster"
Metadata:
  cfn-lint: { config: { ignore_checks: [W9002, W9003, W9004, W9006, E9007, E9008] } }
Parameters:
  KubeClusterName:
      Type: String
  DBHost:
      Type: String
  DBUsername:
      Default: admin
      Description: The database admin account username
      Type: String
      MinLength: '1'
      MaxLength: '16'
      AllowedPattern: '[a-zA-Z][a-zA-Z0-9]*'
      ConstraintDescription: must begin with a letter and contain only alphanumeric characters.
  DBPassword:
    Default: password
    NoEcho: 'true'
    Description: The database admin account password
    Type: String
    MinLength: '8'
    MaxLength: '41'
    AllowedPattern: '[a-zA-Z0-9]*'
    ConstraintDescription: must contain only alphanumeric characters.
Resources:
  KubeManifestInstall:
    Type: "AWSQS::Kubernetes::Resource"
    Metadata: { cfn-lint: { config: { ignore_checks: [E3002] } } }
    Properties:
      ClusterName: !Ref KubeClusterName
      Namespace: kubeflow
      # Kubernetes manifest
      Manifest: !Sub |
            apiVersion: v1
            kind: Namespace
            metadata:
              name: kubeflow
            ---
            apiVersion: apiextensions.k8s.io/v1
            kind: CustomResourceDefinition
            metadata:
              name: clusterworkflowtemplates.argoproj.io
            spec:
              group: argoproj.io
              names:
                kind: ClusterWorkflowTemplate
                listKind: ClusterWorkflowTemplateList
                plural: clusterworkflowtemplates
                shortNames:
                - clusterwftmpl
                - cwft
                singular: clusterworkflowtemplate
              scope: Cluster
              versions:
              - name: v1alpha1
                schema:
                  openAPIV3Schema:
                    properties:
                      apiVersion:
                        type: string
                      kind:
                        type: string
                      metadata:
                        type: object
                      spec:
                        type: object
                        x-kubernetes-map-type: atomic
                        x-kubernetes-preserve-unknown-fields: true
                    required:
                    - metadata
                    - spec
                    type: object
                served: true
                storage: true
            ---
            apiVersion: apiextensions.k8s.io/v1
            kind: CustomResourceDefinition
            metadata:
              name: cronworkflows.argoproj.io
            spec:
              group: argoproj.io
              names:
                kind: CronWorkflow
                listKind: CronWorkflowList
                plural: cronworkflows
                shortNames:
                - cwf
                - cronwf
                singular: cronworkflow
              scope: Namespaced
              versions:
              - name: v1alpha1
                schema:
                  openAPIV3Schema:
                    properties:
                      apiVersion:
                        type: string
                      kind:
                        type: string
                      metadata:
                        type: object
                      spec:
                        type: object
                        x-kubernetes-map-type: atomic
                        x-kubernetes-preserve-unknown-fields: true
                      status:
                        type: object
                        x-kubernetes-map-type: atomic
                        x-kubernetes-preserve-unknown-fields: true
                    required:
                    - metadata
                    - spec
                    type: object
                served: true
                storage: true
            ---
            apiVersion: apiextensions.k8s.io/v1
            kind: CustomResourceDefinition
            metadata:
              name: workfloweventbindings.argoproj.io
            spec:
              group: argoproj.io
              names:
                kind: WorkflowEventBinding
                listKind: WorkflowEventBindingList
                plural: workfloweventbindings
                shortNames:
                - wfeb
                singular: workfloweventbinding
              scope: Namespaced
              versions:
              - name: v1alpha1
                schema:
                  openAPIV3Schema:
                    properties:
                      apiVersion:
                        type: string
                      kind:
                        type: string
                      metadata:
                        type: object
                      spec:
                        type: object
                        x-kubernetes-map-type: atomic
                        x-kubernetes-preserve-unknown-fields: true
                    required:
                    - metadata
                    - spec
                    type: object
                served: true
                storage: true
            ---
            apiVersion: apiextensions.k8s.io/v1
            kind: CustomResourceDefinition
            metadata:
              name: workflows.argoproj.io
            spec:
              group: argoproj.io
              names:
                kind: Workflow
                listKind: WorkflowList
                plural: workflows
                shortNames:
                - wf
                singular: workflow
              scope: Namespaced
              versions:
              - additionalPrinterColumns:
                - description: Status of the workflow
                  jsonPath: .status.phase
                  name: Status
                  type: string
                - description: When the workflow was started
                  format: date-time
                  jsonPath: .status.startedAt
                  name: Age
                  type: date
                name: v1alpha1
                schema:
                  openAPIV3Schema:
                    properties:
                      apiVersion:
                        type: string
                      kind:
                        type: string
                      metadata:
                        type: object
                      spec:
                        type: object
                        x-kubernetes-map-type: atomic
                        x-kubernetes-preserve-unknown-fields: true
                      status:
                        type: object
                        x-kubernetes-map-type: atomic
                        x-kubernetes-preserve-unknown-fields: true
                    required:
                    - metadata
                    - spec
                    type: object
                served: true
                storage: true
                subresources: {}
            ---
            apiVersion: apiextensions.k8s.io/v1
            kind: CustomResourceDefinition
            metadata:
              name: workflowtemplates.argoproj.io
            spec:
              group: argoproj.io
              names:
                kind: WorkflowTemplate
                listKind: WorkflowTemplateList
                plural: workflowtemplates
                shortNames:
                - wftmpl
                singular: workflowtemplate
              scope: Namespaced
              versions:
              - name: v1alpha1
                schema:
                  openAPIV3Schema:
                    properties:
                      apiVersion:
                        type: string
                      kind:
                        type: string
                      metadata:
                        type: object
                      spec:
                        type: object
                        x-kubernetes-map-type: atomic
                        x-kubernetes-preserve-unknown-fields: true
                    required:
                    - metadata
                    - spec
                    type: object
                served: true
                storage: true
            ---
            apiVersion: apiextensions.k8s.io/v1beta1
            kind: CustomResourceDefinition
            metadata:
              labels:
                controller-tools.k8s.io: "1.0"
              name: applications.app.k8s.io
            spec:
              group: app.k8s.io
              names:
                kind: Application
                plural: applications
              scope: Namespaced
              validation:
                openAPIV3Schema:
                  properties:
                    apiVersion:
                      type: string
                    kind:
                      type: string
                    metadata:
                      type: object
                    spec:
                      properties:
                        addOwnerRef:
                          type: boolean
                        assemblyPhase:
                          type: string
                        componentKinds:
                          items:
                            type: object
                          type: array
                        descriptor:
                          properties:
                            description:
                              type: string
                            icons:
                              items:
                                properties:
                                  size:
                                    type: string
                                  src:
                                    type: string
                                  type:
                                    type: string
                                required:
                                - src
                                type: object
                              type: array
                            keywords:
                              items:
                                type: string
                              type: array
                            links:
                              items:
                                properties:
                                  description:
                                    type: string
                                  url:
                                    type: string
                                type: object
                              type: array
                            maintainers:
                              items:
                                properties:
                                  email:
                                    type: string
                                  name:
                                    type: string
                                  url:
                                    type: string
                                type: object
                              type: array
                            notes:
                              type: string
                            owners:
                              items:
                                properties:
                                  email:
                                    type: string
                                  name:
                                    type: string
                                  url:
                                    type: string
                                type: object
                              type: array
                            type:
                              type: string
                            version:
                              type: string
                          type: object
                        info:
                          items:
                            properties:
                              name:
                                type: string
                              type:
                                type: string
                              value:
                                type: string
                              valueFrom:
                                properties:
                                  configMapKeyRef:
                                    properties:
                                      apiVersion:
                                        type: string
                                      fieldPath:
                                        type: string
                                      key:
                                        type: string
                                      kind:
                                        type: string
                                      name:
                                        type: string
                                      namespace:
                                        type: string
                                      resourceVersion:
                                        type: string
                                      uid:
                                        type: string
                                    type: object
                                  ingressRef:
                                    properties:
                                      apiVersion:
                                        type: string
                                      fieldPath:
                                        type: string
                                      host:
                                        type: string
                                      kind:
                                        type: string
                                      name:
                                        type: string
                                      namespace:
                                        type: string
                                      path:
                                        type: string
                                      resourceVersion:
                                        type: string
                                      uid:
                                        type: string
                                    type: object
                                  secretKeyRef:
                                    properties:
                                      apiVersion:
                                        type: string
                                      fieldPath:
                                        type: string
                                      key:
                                        type: string
                                      kind:
                                        type: string
                                      name:
                                        type: string
                                      namespace:
                                        type: string
                                      resourceVersion:
                                        type: string
                                      uid:
                                        type: string
                                    type: object
                                  serviceRef:
                                    properties:
                                      apiVersion:
                                        type: string
                                      fieldPath:
                                        type: string
                                      kind:
                                        type: string
                                      name:
                                        type: string
                                      namespace:
                                        type: string
                                      path:
                                        type: string
                                      port:
                                        format: int32
                                        type: integer
                                      resourceVersion:
                                        type: string
                                      uid:
                                        type: string
                                    type: object
                                  type:
                                    type: string
                                type: object
                            type: object
                          type: array
                        selector:
                          type: object
                      type: object
                    status:
                      properties:
                        components:
                          items:
                            properties:
                              group:
                                type: string
                              kind:
                                type: string
                              link:
                                type: string
                              name:
                                type: string
                              status:
                                type: string
                            type: object
                          type: array
                        conditions:
                          items:
                            properties:
                              lastTransitionTime:
                                format: date-time
                                type: string
                              lastUpdateTime:
                                format: date-time
                                type: string
                              message:
                                type: string
                              reason:
                                type: string
                              status:
                                type: string
                              type:
                                type: string
                            required:
                            - type
                            - status
                            type: object
                          type: array
                        observedGeneration:
                          format: int64
                          type: integer
                      type: object
              version: v1beta1
            ---
            apiVersion: apiextensions.k8s.io/v1beta1
            kind: CustomResourceDefinition
            metadata:
              name: scheduledworkflows.kubeflow.org
            spec:
              group: kubeflow.org
              names:
                kind: ScheduledWorkflow
                listKind: ScheduledWorkflowList
                plural: scheduledworkflows
                shortNames:
                - swf
                singular: scheduledworkflow
              scope: Namespaced
              versions:
              - name: v1beta1
                served: true
                storage: true
            ---
            apiVersion: apiextensions.k8s.io/v1beta1
            kind: CustomResourceDefinition
            metadata:
              name: viewers.kubeflow.org
            spec:
              group: kubeflow.org
              names:
                kind: Viewer
                listKind: ViewerList
                plural: viewers
                shortNames:
                - vi
                singular: viewer
              scope: Namespaced
              versions:
              - name: v1beta1
                served: true
                storage: true
            ---
            apiVersion: v1
            kind: ServiceAccount
            metadata:
              labels:
                application-crd-id: kubeflow-pipelines
              name: argo
              namespace: kubeflow
            ---
            apiVersion: v1
            kind: ServiceAccount
            metadata:
              name: kubeflow-pipelines-cache-deployer-sa
              namespace: kubeflow
            ---
            apiVersion: v1
            kind: ServiceAccount
            metadata:
              labels:
                app: cache-server
                application-crd-id: kubeflow-pipelines
              name: kubeflow-pipelines-cache
              namespace: kubeflow
            ---
            apiVersion: v1
            kind: ServiceAccount
            metadata:
              labels:
                application-crd-id: kubeflow-pipelines
              name: kubeflow-pipelines-container-builder
              namespace: kubeflow
            ---
            apiVersion: v1
            kind: ServiceAccount
            metadata:
              labels:
                application-crd-id: kubeflow-pipelines
              name: kubeflow-pipelines-metadata-writer
              namespace: kubeflow
            ---
            apiVersion: v1
            kind: ServiceAccount
            metadata:
              labels:
                application-crd-id: kubeflow-pipelines
              name: kubeflow-pipelines-viewer
              namespace: kubeflow
            ---
            apiVersion: v1
            kind: ServiceAccount
            metadata:
              labels:
                application-crd-id: kubeflow-pipelines
              name: metadata-grpc-server
              namespace: kubeflow
            ---
            apiVersion: v1
            kind: ServiceAccount
            metadata:
              labels:
                application-crd-id: kubeflow-pipelines
              name: ml-pipeline-persistenceagent
              namespace: kubeflow
            ---
            apiVersion: v1
            kind: ServiceAccount
            metadata:
              labels:
                application-crd-id: kubeflow-pipelines
              name: ml-pipeline-scheduledworkflow
              namespace: kubeflow
            ---
            apiVersion: v1
            kind: ServiceAccount
            metadata:
              labels:
                application-crd-id: kubeflow-pipelines
              name: ml-pipeline-ui
              namespace: kubeflow
            ---
            apiVersion: v1
            kind: ServiceAccount
            metadata:
              labels:
                application-crd-id: kubeflow-pipelines
              name: ml-pipeline-viewer-crd-service-account
              namespace: kubeflow
            ---
            apiVersion: v1
            kind: ServiceAccount
            metadata:
              labels:
                application-crd-id: kubeflow-pipelines
              name: ml-pipeline-visualizationserver
              namespace: kubeflow
            ---
            apiVersion: v1
            kind: ServiceAccount
            metadata:
              labels:
                application-crd-id: kubeflow-pipelines
              name: ml-pipeline
              namespace: kubeflow
            ---
            apiVersion: v1
            kind: ServiceAccount
            metadata:
              labels:
                application-crd-id: kubeflow-pipelines
              name: pipeline-runner
              namespace: kubeflow
            ---
            apiVersion: rbac.authorization.k8s.io/v1
            kind: Role
            metadata:
              labels:
                application-crd-id: kubeflow-pipelines
              name: argo-role
              namespace: kubeflow
            rules:
            - apiGroups:
              - coordination.k8s.io
              resources:
              - leases
              verbs:
              - create
              - get
              - update
            - apiGroups:
              - ""
              resources:
              - pods
              - pods/exec
              verbs:
              - create
              - get
              - list
              - watch
              - update
              - patch
              - delete
            - apiGroups:
              - ""
              resources:
              - configmaps
              verbs:
              - get
              - watch
              - list
            - apiGroups:
              - ""
              resources:
              - persistentvolumeclaims
              verbs:
              - create
              - delete
              - get
            - apiGroups:
              - argoproj.io
              resources:
              - workflows
              - workflows/finalizers
              verbs:
              - get
              - list
              - watch
              - update
              - patch
              - delete
              - create
            - apiGroups:
              - argoproj.io
              resources:
              - workflowtemplates
              - workflowtemplates/finalizers
              verbs:
              - get
              - list
              - watch
            - apiGroups:
              - ""
              resources:
              - serviceaccounts
              verbs:
              - get
              - list
            - apiGroups:
              - ""
              resources:
              - secrets
              verbs:
              - get
            - apiGroups:
              - argoproj.io
              resources:
              - cronworkflows
              - cronworkflows/finalizers
              verbs:
              - get
              - list
              - watch
              - update
              - patch
              - delete
            - apiGroups:
              - ""
              resources:
              - events
              verbs:
              - create
              - patch
            - apiGroups:
              - policy
              resources:
              - poddisruptionbudgets
              verbs:
              - create
              - get
              - delete
            ---
            apiVersion: rbac.authorization.k8s.io/v1
            kind: Role
            metadata:
              labels:
                app: cache-deployer
                application-crd-id: kubeflow-pipelines
              name: kubeflow-pipelines-cache-deployer-role
              namespace: kubeflow
            rules:
            - apiGroups:
              - ""
              resources:
              - secrets
              verbs:
              - create
              - delete
              - get
              - patch
              - list
            ---
            apiVersion: rbac.authorization.k8s.io/v1
            kind: Role
            metadata:
              labels:
                app: cache-server
                application-crd-id: kubeflow-pipelines
              name: kubeflow-pipelines-cache-role
              namespace: kubeflow
            rules:
            - apiGroups:
              - ""
              resources:
              - pods
              verbs:
              - get
              - list
              - watch
              - update
              - patch
            - apiGroups:
              - ""
              resources:
              - configmaps
              verbs:
              - get
            - apiGroups:
              - argoproj.io
              resources:
              - workflows
              verbs:
              - get
              - list
              - watch
              - update
              - patch
            ---
            apiVersion: rbac.authorization.k8s.io/v1
            kind: Role
            metadata:
              labels:
                app: kubeflow-pipelines-metadata-writer-role
                application-crd-id: kubeflow-pipelines
              name: kubeflow-pipelines-metadata-writer-role
              namespace: kubeflow
            rules:
            - apiGroups:
              - ""
              resources:
              - pods
              verbs:
              - get
              - list
              - watch
              - update
              - patch
            - apiGroups:
              - ""
              resources:
              - configmaps
              verbs:
              - get
            - apiGroups:
              - argoproj.io
              resources:
              - workflows
              verbs:
              - get
              - list
              - watch
              - update
              - patch
            ---
            apiVersion: rbac.authorization.k8s.io/v1
            kind: Role
            metadata:
              labels:
                application-crd-id: kubeflow-pipelines
              name: ml-pipeline-persistenceagent-role
              namespace: kubeflow
            rules:
            - apiGroups:
              - argoproj.io
              resources:
              - workflows
              verbs:
              - get
              - list
              - watch
            - apiGroups:
              - kubeflow.org
              resources:
              - scheduledworkflows
              verbs:
              - get
              - list
              - watch
            ---
            apiVersion: rbac.authorization.k8s.io/v1
            kind: Role
            metadata:
              labels:
                app: ml-pipeline-scheduledworkflow-role
                application-crd-id: kubeflow-pipelines
              name: ml-pipeline-scheduledworkflow-role
              namespace: kubeflow
            rules:
            - apiGroups:
              - argoproj.io
              resources:
              - workflows
              verbs:
              - create
              - get
              - list
              - watch
              - update
              - patch
              - delete
            - apiGroups:
              - kubeflow.org
              resources:
              - scheduledworkflows
              verbs:
              - create
              - get
              - list
              - watch
              - update
              - patch
              - delete
            - apiGroups:
              - ""
              resources:
              - events
              verbs:
              - create
              - patch
            ---
            apiVersion: rbac.authorization.k8s.io/v1
            kind: Role
            metadata:
              labels:
                app: ml-pipeline-ui
                application-crd-id: kubeflow-pipelines
              name: ml-pipeline-ui
              namespace: kubeflow
            rules:
            - apiGroups:
              - ""
              resources:
              - pods
              - pods/log
              verbs:
              - get
            - apiGroups:
              - ""
              resources:
              - events
              verbs:
              - list
            - apiGroups:
              - ""
              resources:
              - secrets
              verbs:
              - get
              - list
            - apiGroups:
              - kubeflow.org
              resources:
              - viewers
              verbs:
              - create
              - get
              - list
              - watch
              - delete
            - apiGroups:
              - argoproj.io
              resources:
              - workflows
              verbs:
              - get
              - list
            ---
            apiVersion: rbac.authorization.k8s.io/v1
            kind: Role
            metadata:
              labels:
                application-crd-id: kubeflow-pipelines
              name: ml-pipeline-viewer-controller-role
              namespace: kubeflow
            rules:
            - apiGroups:
              - '*'
              resources:
              - deployments
              - services
              verbs:
              - create
              - get
              - list
              - watch
              - update
              - patch
              - delete
            - apiGroups:
              - kubeflow.org
              resources:
              - viewers
              verbs:
              - create
              - get
              - list
              - watch
              - update
              - patch
              - delete
            ---
            apiVersion: rbac.authorization.k8s.io/v1
            kind: Role
            metadata:
              labels:
                app: ml-pipeline
                application-crd-id: kubeflow-pipelines
              name: ml-pipeline
              namespace: kubeflow
            rules:
            - apiGroups:
              - ""
              resources:
              - pods
              - pods/log
              verbs:
              - get
              - list
              - delete
            - apiGroups:
              - argoproj.io
              resources:
              - workflows
              verbs:
              - create
              - get
              - list
              - watch
              - update
              - patch
              - delete
            - apiGroups:
              - kubeflow.org
              resources:
              - scheduledworkflows
              verbs:
              - create
              - get
              - list
              - update
              - patch
              - delete
            - apiGroups:
              - authorization.k8s.io
              resources:
              - subjectaccessreviews
              verbs:
              - create
            - apiGroups:
              - authentication.k8s.io
              resources:
              - tokenreviews
              verbs:
              - create
            ---
            apiVersion: rbac.authorization.k8s.io/v1
            kind: Role
            metadata:
              labels:
                application-crd-id: kubeflow-pipelines
              name: pipeline-runner
              namespace: kubeflow
            rules:
            - apiGroups:
              - ""
              resources:
              - secrets
              verbs:
              - get
            - apiGroups:
              - ""
              resources:
              - configmaps
              verbs:
              - get
              - watch
              - list
            - apiGroups:
              - ""
              resources:
              - persistentvolumes
              - persistentvolumeclaims
              verbs:
              - '*'
            - apiGroups:
              - snapshot.storage.k8s.io
              resources:
              - volumesnapshots
              verbs:
              - create
              - delete
              - get
            - apiGroups:
              - argoproj.io
              resources:
              - workflows
              verbs:
              - get
              - list
              - watch
              - update
              - patch
            - apiGroups:
              - ""
              resources:
              - pods
              - pods/exec
              - pods/log
              - services
              verbs:
              - '*'
            - apiGroups:
              - ""
              - apps
              - extensions
              resources:
              - deployments
              - replicasets
              verbs:
              - '*'
            - apiGroups:
              - kubeflow.org
              resources:
              - '*'
              verbs:
              - '*'
            - apiGroups:
              - batch
              resources:
              - jobs
              verbs:
              - '*'
            - apiGroups:
              - machinelearning.seldon.io
              resources:
              - seldondeployments
              verbs:
              - '*'
            ---
            apiVersion: rbac.authorization.k8s.io/v1
            kind: ClusterRole
            metadata:
              labels:
                app: kubeflow-pipelines-cache-deployer-clusterrole
              name: kubeflow-pipelines-cache-deployer-clusterrole
            rules:
            - apiGroups:
              - certificates.k8s.io
              resources:
              - certificatesigningrequests
              - certificatesigningrequests/approval
              verbs:
              - create
              - delete
              - get
              - update
            - apiGroups:
              - admissionregistration.k8s.io
              resources:
              - mutatingwebhookconfigurations
              verbs:
              - create
              - delete
              - get
              - list
              - patch
            - apiGroups:
              - certificates.k8s.io
              resourceNames:
              - kubernetes.io/*
              resources:
              - signers
              verbs:
              - approve
            ---
            apiVersion: rbac.authorization.k8s.io/v1
            kind: RoleBinding
            metadata:
              labels:
                application-crd-id: kubeflow-pipelines
              name: argo-binding
              namespace: kubeflow
            roleRef:
              apiGroup: rbac.authorization.k8s.io
              kind: Role
              name: argo-role
            subjects:
            - kind: ServiceAccount
              name: argo
              namespace: kubeflow
            ---
            apiVersion: rbac.authorization.k8s.io/v1
            kind: RoleBinding
            metadata:
              labels:
                app: cache-server
                application-crd-id: kubeflow-pipelines
              name: kubeflow-pipelines-cache-binding
              namespace: kubeflow
            roleRef:
              apiGroup: rbac.authorization.k8s.io
              kind: Role
              name: kubeflow-pipelines-cache-role
            subjects:
            - kind: ServiceAccount
              name: kubeflow-pipelines-cache
              namespace: kubeflow
            ---
            apiVersion: rbac.authorization.k8s.io/v1
            kind: RoleBinding
            metadata:
              labels:
                app: cache-deployer
                application-crd-id: kubeflow-pipelines
              name: kubeflow-pipelines-cache-deployer-rolebinding
              namespace: kubeflow
            roleRef:
              apiGroup: rbac.authorization.k8s.io
              kind: Role
              name: kubeflow-pipelines-cache-deployer-role
            subjects:
            - kind: ServiceAccount
              name: kubeflow-pipelines-cache-deployer-sa
            ---
            apiVersion: rbac.authorization.k8s.io/v1
            kind: RoleBinding
            metadata:
              labels:
                application-crd-id: kubeflow-pipelines
              name: kubeflow-pipelines-metadata-writer-binding
              namespace: kubeflow
            roleRef:
              apiGroup: rbac.authorization.k8s.io
              kind: Role
              name: kubeflow-pipelines-metadata-writer-role
            subjects:
            - kind: ServiceAccount
              name: kubeflow-pipelines-metadata-writer
              namespace: kubeflow
            ---
            apiVersion: rbac.authorization.k8s.io/v1
            kind: RoleBinding
            metadata:
              labels:
                application-crd-id: kubeflow-pipelines
              name: ml-pipeline-persistenceagent-binding
              namespace: kubeflow
            roleRef:
              apiGroup: rbac.authorization.k8s.io
              kind: Role
              name: ml-pipeline-persistenceagent-role
            subjects:
            - kind: ServiceAccount
              name: ml-pipeline-persistenceagent
              namespace: kubeflow
            ---
            apiVersion: rbac.authorization.k8s.io/v1
            kind: RoleBinding
            metadata:
              labels:
                application-crd-id: kubeflow-pipelines
              name: ml-pipeline-scheduledworkflow-binding
              namespace: kubeflow
            roleRef:
              apiGroup: rbac.authorization.k8s.io
              kind: Role
              name: ml-pipeline-scheduledworkflow-role
            subjects:
            - kind: ServiceAccount
              name: ml-pipeline-scheduledworkflow
              namespace: kubeflow
            ---
            apiVersion: rbac.authorization.k8s.io/v1
            kind: RoleBinding
            metadata:
              labels:
                app: ml-pipeline-ui
                application-crd-id: kubeflow-pipelines
              name: ml-pipeline-ui
              namespace: kubeflow
            roleRef:
              apiGroup: rbac.authorization.k8s.io
              kind: Role
              name: ml-pipeline-ui
            subjects:
            - kind: ServiceAccount
              name: ml-pipeline-ui
              namespace: kubeflow
            ---
            apiVersion: rbac.authorization.k8s.io/v1
            kind: RoleBinding
            metadata:
              labels:
                application-crd-id: kubeflow-pipelines
              name: ml-pipeline-viewer-crd-binding
              namespace: kubeflow
            roleRef:
              apiGroup: rbac.authorization.k8s.io
              kind: Role
              name: ml-pipeline-viewer-controller-role
            subjects:
            - kind: ServiceAccount
              name: ml-pipeline-viewer-crd-service-account
              namespace: kubeflow
            ---
            apiVersion: rbac.authorization.k8s.io/v1
            kind: RoleBinding
            metadata:
              labels:
                app: ml-pipeline
                application-crd-id: kubeflow-pipelines
              name: ml-pipeline
              namespace: kubeflow
            roleRef:
              apiGroup: rbac.authorization.k8s.io
              kind: Role
              name: ml-pipeline
            subjects:
            - kind: ServiceAccount
              name: ml-pipeline
              namespace: kubeflow
            ---
            apiVersion: rbac.authorization.k8s.io/v1
            kind: RoleBinding
            metadata:
              labels:
                application-crd-id: kubeflow-pipelines
              name: pipeline-runner-binding
              namespace: kubeflow
            roleRef:
              apiGroup: rbac.authorization.k8s.io
              kind: Role
              name: pipeline-runner
            subjects:
            - kind: ServiceAccount
              name: pipeline-runner
              namespace: kubeflow
            ---
            apiVersion: rbac.authorization.k8s.io/v1
            kind: ClusterRoleBinding
            metadata:
              name: kubeflow-pipelines-cache-deployer-clusterrolebinding
            roleRef:
              apiGroup: rbac.authorization.k8s.io
              kind: ClusterRole
              name: kubeflow-pipelines-cache-deployer-clusterrole
            subjects:
            - kind: ServiceAccount
              name: kubeflow-pipelines-cache-deployer-sa
              namespace: kubeflow
            ---
            apiVersion: v1
            data:
              defaultPipelineRoot: ""
            kind: ConfigMap
            metadata:
              labels:
                application-crd-id: kubeflow-pipelines
              name: kfp-launcher
              namespace: kubeflow
            ---
            apiVersion: v1
            data:
              METADATA_GRPC_SERVICE_HOST: metadata-grpc-service
              METADATA_GRPC_SERVICE_PORT: "8080"
            kind: ConfigMap
            metadata:
              labels:
                application-crd-id: kubeflow-pipelines
                component: metadata-grpc-server
              name: metadata-grpc-configmap
              namespace: kubeflow
            ---
            apiVersion: v1
            data:
              viewer-pod-template.json: |-
                {
                    "spec": {
                        "serviceAccountName": "kubeflow-pipelines-viewer"
                    }
                }
            kind: ConfigMap
            metadata:
              labels:
                application-crd-id: kubeflow-pipelines
              name: ml-pipeline-ui-configmap
              namespace: kubeflow
            ---
            apiVersion: v1
            data:
              ConMaxLifeTimeSec: "120"
              appName: pipeline
              appVersion: 1.7.0-rc.3
              autoUpdatePipelineDefaultVersion: "true"
              bucketName: mlpipeline
              cacheDb: cachedb
              cacheImage: gcr.io/google-containers/busybox
              cacheNodeRestrictions: "false"
              cronScheduleTimezone: UTC
              dbHost: ${DBHost}
              dbPort: "3306"
              defaultPipelineRoot: ""
              mlmdDb: metadb
              pipelineDb: mlpipeline
              warning: |
                1. Do not use kubectl to edit this configmap, because some values are used
                during kustomize build. Instead, change the configmap and apply the entire
                kustomize manifests again.
                2. After updating the configmap, some deployments may need to be restarted
                until the changes take effect. A quick way to restart all deployments in a
                namespace: `kubectl rollout restart deployment -n <your-namespace>`.
            kind: ConfigMap
            metadata:
              annotations: {}
              labels:
                application-crd-id: kubeflow-pipelines
              name: pipeline-install-config
              namespace: kubeflow
            ---
            apiVersion: v1
            data:
              artifactRepository: |
                archiveLogs: true
                s3:
                  endpoint: "minio-service.kubeflow:9000"
                  bucket: "mlpipeline"
                  keyPrefix: "artifacts"
                  # keyFormat is a format pattern to define how artifacts will be organized in a bucket.
                  # It can reference workflow metadata variables such as workflow.namespace, workflow.name,
                  # pod.name. Can also use strftime formating of workflow.creationTimestamp so that workflow
                  # artifacts can be organized by date. If omitted, will use `{{workflow.name}}/{{pod.name}}`,
                  # which has potential for have collisions, because names do not guarantee they are unique
                  # over the lifetime of the cluster.
                  # Refer to https://kubernetes.io/docs/concepts/overview/working-with-objects/names/.
                  #
                  # The following format looks like:
                  # artifacts/my-workflow-abc123/2018/08/23/my-workflow-abc123-1234567890
                  # Adding date into the path greatly reduces the chance of {{pod.name}} collision.
                  keyFormat: "artifacts/{{workflow.name}}/{{workflow.creationTimestamp.Y}}/{{workflow.creationTimestamp.m}}/{{workflow.creationTimestamp.d}}/{{pod.name}}"
                  # insecure will disable TLS. Primarily used for minio installs not configured with TLS
                  insecure: true
                  accessKeySecret:
                    name: mlpipeline-minio-artifact
                    key: accesskey
                  secretKeySecret:
                    name: mlpipeline-minio-artifact
                    key: secretkey
              containerRuntimeExecutor: docker
              executor: |
                imagePullPolicy: IfNotPresent
                resources:
                  requests:
                    cpu: 0.01
                    memory: 32Mi
                  limits:
                    cpu: 0.5
                    memory: 512Mi
            kind: ConfigMap
            metadata:
              labels:
                application-crd-id: kubeflow-pipelines
              name: workflow-controller-configmap
              namespace: kubeflow
            ---
            apiVersion: v1
            kind: Secret
            metadata:
              labels:
                application-crd-id: kubeflow-pipelines
              name: mlpipeline-minio-artifact
              namespace: kubeflow
            stringData:
              accesskey: minio
              secretkey: sdlkjfhb5fdd2
            ---
            apiVersion: v1
            kind: Secret
            metadata:
              annotations: {}
              labels:
                application-crd-id: kubeflow-pipelines
              name: mysql-secret
              namespace: kubeflow
            stringData:
              password: ${DBPassword}
              username: ${DBUsername}
            type: Opaque
            ---
            apiVersion: v1
            kind: Service
            metadata:
              labels:
                app: cache-server
                application-crd-id: kubeflow-pipelines
              name: cache-server
              namespace: kubeflow
            spec:
              ports:
              - port: 443
                targetPort: webhook-api
              selector:
                app: cache-server
                application-crd-id: kubeflow-pipelines
            ---
            apiVersion: v1
            kind: Service
            metadata:
              labels:
                app: metadata-envoy
                application-crd-id: kubeflow-pipelines
              name: metadata-envoy-service
              namespace: kubeflow
            spec:
              ports:
              - name: md-envoy
                port: 9090
                protocol: TCP
              selector:
                application-crd-id: kubeflow-pipelines
                component: metadata-envoy
              type: ClusterIP
            ---
            apiVersion: v1
            kind: Service
            metadata:
              labels:
                app: metadata
                application-crd-id: kubeflow-pipelines
              name: metadata-grpc-service
              namespace: kubeflow
            spec:
              ports:
              - name: grpc-api
                port: 8080
                protocol: TCP
              selector:
                application-crd-id: kubeflow-pipelines
                component: metadata-grpc-server
              type: ClusterIP
            ---
            apiVersion: v1
            kind: Service
            metadata:
              labels:
                application-crd-id: kubeflow-pipelines
              name: minio-service
              namespace: kubeflow
            spec:
              ports:
              - name: http
                port: 9000
                protocol: TCP
                targetPort: 9000
              selector:
                app: minio
                application-crd-id: kubeflow-pipelines
            ---
            apiVersion: v1
            kind: Service
            metadata:
              labels:
                app: ml-pipeline-ui
                application-crd-id: kubeflow-pipelines
              name: ml-pipeline-ui
              namespace: kubeflow
            spec:
              ports:
              - name: http
                port: 80
                protocol: TCP
                targetPort: 3000
              selector:
                app: ml-pipeline-ui
                application-crd-id: kubeflow-pipelines
            ---
            apiVersion: v1
            kind: Service
            metadata:
              labels:
                application-crd-id: kubeflow-pipelines
              name: ml-pipeline-visualizationserver
              namespace: kubeflow
            spec:
              ports:
              - name: http
                port: 8888
                protocol: TCP
                targetPort: 8888
              selector:
                app: ml-pipeline-visualizationserver
                application-crd-id: kubeflow-pipelines
            ---
            apiVersion: v1
            kind: Service
            metadata:
              labels:
                application-crd-id: kubeflow-pipelines
              name: ml-pipeline
              namespace: kubeflow
            spec:
              ports:
              - name: http
                port: 8888
                protocol: TCP
                targetPort: 8888
              - name: grpc
                port: 8887
                protocol: TCP
                targetPort: 8887
              selector:
                app: ml-pipeline
                application-crd-id: kubeflow-pipelines
            ---
            apiVersion: v1
            kind: Service
            metadata:
              labels:
                app: workflow-controller
                application-crd-id: kubeflow-pipelines
              name: workflow-controller-metrics
              namespace: kubeflow
            spec:
              ports:
              - name: metrics
                port: 9090
                protocol: TCP
                targetPort: 9090
              selector:
                app: workflow-controller
                application-crd-id: kubeflow-pipelines
            ---
            apiVersion: apps/v1
            kind: Deployment
            metadata:
              labels:
                app: cache-deployer
                application-crd-id: kubeflow-pipelines
              name: cache-deployer-deployment
              namespace: kubeflow
            spec:
              replicas: 3
              selector:
                matchLabels:
                  app: cache-deployer
                  application-crd-id: kubeflow-pipelines
              strategy:
                type: Recreate
              template:
                metadata:
                  labels:
                    app: cache-deployer
                    application-crd-id: kubeflow-pipelines
                spec:
                  affinity:
                    nodeAffinity:
                      requiredDuringSchedulingIgnoredDuringExecution:
                        nodeSelectorTerms:
                        - matchExpressions:
                          - key: system-worker
                            operator: Exists
                    podAntiAffinity:
                      requiredDuringSchedulingIgnoredDuringExecution:
                      - labelSelector:
                          matchExpressions:
                          - key: app
                            operator: In
                            values:
                            - cache-deployer
                        topologyKey: kubernetes.io/hostname
                  containers:
                  - env:
                    - name: NAMESPACE_TO_WATCH
                      valueFrom:
                        fieldRef:
                          fieldPath: metadata.namespace
                    image: gcr.io/ml-pipeline/cache-deployer:1.7.0-rc.3
                    imagePullPolicy: Always
                    name: main
                  restartPolicy: Always
                  serviceAccountName: kubeflow-pipelines-cache-deployer-sa
                  tolerations:
                  - effect: NoSchedule
                    key: system
                    operator: Exists
            ---
            apiVersion: apps/v1
            kind: Deployment
            metadata:
              labels:
                app: cache-server
                application-crd-id: kubeflow-pipelines
              name: cache-server
              namespace: kubeflow
            spec:
              replicas: 3
              selector:
                matchLabels:
                  app: cache-server
                  application-crd-id: kubeflow-pipelines
              template:
                metadata:
                  labels:
                    app: cache-server
                    application-crd-id: kubeflow-pipelines
                spec:
                  affinity:
                    nodeAffinity:
                      requiredDuringSchedulingIgnoredDuringExecution:
                        nodeSelectorTerms:
                        - matchExpressions:
                          - key: system-worker
                            operator: Exists
                    podAntiAffinity:
                      requiredDuringSchedulingIgnoredDuringExecution:
                      - labelSelector:
                          matchExpressions:
                          - key: app
                            operator: In
                            values:
                            - cache-server
                        topologyKey: kubernetes.io/hostname
                  containers:
                  - args:
                    - --db_driver=$(DBCONFIG_DRIVER)
                    - --db_host=$(DBCONFIG_HOST_NAME)
                    - --db_port=$(DBCONFIG_PORT)
                    - --db_name=$(DBCONFIG_DB_NAME)
                    - --db_user=$(DBCONFIG_USER)
                    - --db_password=$(DBCONFIG_PASSWORD)
                    - --namespace_to_watch=$(NAMESPACE_TO_WATCH)
                    env:
                    - name: CACHE_IMAGE
                      valueFrom:
                        configMapKeyRef:
                          key: cacheImage
                          name: pipeline-install-config
                    - name: CACHE_NODE_RESTRICTIONS
                      valueFrom:
                        configMapKeyRef:
                          key: cacheNodeRestrictions
                          name: pipeline-install-config
                    - name: DBCONFIG_DRIVER
                      value: mysql
                    - name: DBCONFIG_DB_NAME
                      valueFrom:
                        configMapKeyRef:
                          key: cacheDb
                          name: pipeline-install-config
                    - name: DBCONFIG_HOST_NAME
                      valueFrom:
                        configMapKeyRef:
                          key: dbHost
                          name: pipeline-install-config
                    - name: DBCONFIG_PORT
                      valueFrom:
                        configMapKeyRef:
                          key: dbPort
                          name: pipeline-install-config
                    - name: DBCONFIG_USER
                      valueFrom:
                        secretKeyRef:
                          key: username
                          name: mysql-secret
                    - name: DBCONFIG_PASSWORD
                      valueFrom:
                        secretKeyRef:
                          key: password
                          name: mysql-secret
                    - name: NAMESPACE_TO_WATCH
                      valueFrom:
                        fieldRef:
                          fieldPath: metadata.namespace
                    image: gcr.io/ml-pipeline/cache-server:1.7.0-rc.3
                    imagePullPolicy: Always
                    name: server
                    ports:
                    - containerPort: 8443
                      name: webhook-api
                    volumeMounts:
                    - mountPath: /etc/webhook/certs
                      name: webhook-tls-certs
                      readOnly: true
                  serviceAccountName: kubeflow-pipelines-cache
                  tolerations:
                  - effect: NoSchedule
                    key: system
                    operator: Exists
                  volumes:
                  - name: webhook-tls-certs
                    secret:
                      secretName: webhook-server-tls
            ---
            apiVersion: apps/v1
            kind: Deployment
            metadata:
              labels:
                application-crd-id: kubeflow-pipelines
                component: metadata-envoy
              name: metadata-envoy-deployment
              namespace: kubeflow
            spec:
              replicas: 3
              selector:
                matchLabels:
                  application-crd-id: kubeflow-pipelines
                  component: metadata-envoy
              template:
                metadata:
                  annotations:
                    sidecar.istio.io/inject: "false"
                  labels:
                    application-crd-id: kubeflow-pipelines
                    component: metadata-envoy
                spec:
                  affinity:
                    nodeAffinity:
                      requiredDuringSchedulingIgnoredDuringExecution:
                        nodeSelectorTerms:
                        - matchExpressions:
                          - key: system-worker
                            operator: Exists
                    podAntiAffinity:
                      requiredDuringSchedulingIgnoredDuringExecution:
                      - labelSelector:
                          matchExpressions:
                          - key: component
                            operator: In
                            values:
                            - metadata-envoy
                        topologyKey: kubernetes.io/hostname
                  containers:
                  - image: gcr.io/ml-pipeline/metadata-envoy:1.7.0-rc.3
                    name: container
                    ports:
                    - containerPort: 9090
                      name: md-envoy
                    - containerPort: 9901
                      name: envoy-admin
                  tolerations:
                  - effect: NoSchedule
                    key: system
                    operator: Exists
            ---
            apiVersion: apps/v1
            kind: Deployment
            metadata:
              labels:
                application-crd-id: kubeflow-pipelines
                component: metadata-grpc-server
              name: metadata-grpc-deployment
              namespace: kubeflow
            spec:
              replicas: 3
              selector:
                matchLabels:
                  application-crd-id: kubeflow-pipelines
                  component: metadata-grpc-server
              template:
                metadata:
                  labels:
                    application-crd-id: kubeflow-pipelines
                    component: metadata-grpc-server
                spec:
                  affinity:
                    nodeAffinity:
                      requiredDuringSchedulingIgnoredDuringExecution:
                        nodeSelectorTerms:
                        - matchExpressions:
                          - key: system-worker
                            operator: Exists
                    podAntiAffinity:
                      requiredDuringSchedulingIgnoredDuringExecution:
                      - labelSelector:
                          matchExpressions:
                          - key: component
                            operator: In
                            values:
                            - metadata-grpc-server
                        topologyKey: kubernetes.io/hostname
                  containers:
                  - args:
                    - --grpc_port=8080
                    - --mysql_config_database=$(MYSQL_DATABASE)
                    - --mysql_config_host=$(MYSQL_HOST)
                    - --mysql_config_port=$(MYSQL_PORT)
                    - --mysql_config_user=$(DBCONFIG_USER)
                    - --mysql_config_password=$(DBCONFIG_PASSWORD)
                    - --enable_database_upgrade=true
                    command:
                    - /bin/metadata_store_server
                    env:
                    - name: DBCONFIG_USER
                      valueFrom:
                        secretKeyRef:
                          key: username
                          name: mysql-secret
                    - name: DBCONFIG_PASSWORD
                      valueFrom:
                        secretKeyRef:
                          key: password
                          name: mysql-secret
                    - name: MYSQL_DATABASE
                      valueFrom:
                        configMapKeyRef:
                          key: mlmdDb
                          name: pipeline-install-config
                    - name: MYSQL_HOST
                      valueFrom:
                        configMapKeyRef:
                          key: dbHost
                          name: pipeline-install-config
                    - name: MYSQL_PORT
                      valueFrom:
                        configMapKeyRef:
                          key: dbPort
                          name: pipeline-install-config
                    image: gcr.io/tfx-oss-public/ml_metadata_store_server:1.0.0
                    livenessProbe:
                      initialDelaySeconds: 3
                      periodSeconds: 5
                      tcpSocket:
                        port: grpc-api
                      timeoutSeconds: 2
                    name: container
                    ports:
                    - containerPort: 8080
                      name: grpc-api
                    readinessProbe:
                      initialDelaySeconds: 3
                      periodSeconds: 5
                      tcpSocket:
                        port: grpc-api
                      timeoutSeconds: 2
                  serviceAccountName: metadata-grpc-server
                  tolerations:
                  - effect: NoSchedule
                    key: system
                    operator: Exists
            ---
            apiVersion: apps/v1
            kind: Deployment
            metadata:
              labels:
                app: metadata-writer
                application-crd-id: kubeflow-pipelines
              name: metadata-writer
              namespace: kubeflow
            spec:
              replicas: 3
              selector:
                matchLabels:
                  app: metadata-writer
                  application-crd-id: kubeflow-pipelines
              template:
                metadata:
                  labels:
                    app: metadata-writer
                    application-crd-id: kubeflow-pipelines
                spec:
                  affinity:
                    nodeAffinity:
                      requiredDuringSchedulingIgnoredDuringExecution:
                        nodeSelectorTerms:
                        - matchExpressions:
                          - key: system-worker
                            operator: Exists
                    podAntiAffinity:
                      requiredDuringSchedulingIgnoredDuringExecution:
                      - labelSelector:
                          matchExpressions:
                          - key: app
                            operator: In
                            values:
                            - metadata-writer
                        topologyKey: kubernetes.io/hostname
                  containers:
                  - env:
                    - name: NAMESPACE_TO_WATCH
                      valueFrom:
                        fieldRef:
                          fieldPath: metadata.namespace
                    image: gcr.io/ml-pipeline/metadata-writer:1.7.0-rc.3
                    name: main
                  serviceAccountName: kubeflow-pipelines-metadata-writer
                  tolerations:
                  - effect: NoSchedule
                    key: system
                    operator: Exists
            ---
            apiVersion: apps/v1
            kind: Deployment
            metadata:
              labels:
                app: minio
                application-crd-id: kubeflow-pipelines
              name: minio
              namespace: kubeflow
            spec:
              replicas: 3
              selector:
                matchLabels:
                  app: minio
                  application-crd-id: kubeflow-pipelines
              strategy:
                type: Recreate
              template:
                metadata:
                  labels:
                    app: minio
                    application-crd-id: kubeflow-pipelines
                spec:
                  affinity:
                    nodeAffinity:
                      requiredDuringSchedulingIgnoredDuringExecution:
                        nodeSelectorTerms:
                        - matchExpressions:
                          - key: system-worker
                            operator: Exists
                    podAntiAffinity:
                      requiredDuringSchedulingIgnoredDuringExecution:
                      - labelSelector:
                          matchExpressions:
                          - key: app
                            operator: In
                            values:
                            - minio
                        topologyKey: kubernetes.io/hostname
                  containers:
                  - args:
                    - server
                    - /data
                    env:
                    - name: MINIO_ACCESS_KEY
                      valueFrom:
                        secretKeyRef:
                          key: accesskey
                          name: mlpipeline-minio-artifact
                    - name: MINIO_SECRET_KEY
                      valueFrom:
                        secretKeyRef:
                          key: secretkey
                          name: mlpipeline-minio-artifact
                    image: gcr.io/ml-pipeline/minio:RELEASE.2019-08-14T20-37-41Z-license-compliance
                    name: minio
                    ports:
                    - containerPort: 9000
                    resources:
                      requests:
                        cpu: 20m
                        memory: 100Mi
                    volumeMounts:
                    - mountPath: /data
                      name: data
                      subPath: minio
                  tolerations:
                  - effect: NoSchedule
                    key: system
                    operator: Exists
                  volumes:
                  - name: data
                    persistentVolumeClaim:
                      claimName: minio-pvc
            ---
            apiVersion: apps/v1
            kind: Deployment
            metadata:
              labels:
                app: ml-pipeline-persistenceagent
                application-crd-id: kubeflow-pipelines
              name: ml-pipeline-persistenceagent
              namespace: kubeflow
            spec:
              replicas: 3
              selector:
                matchLabels:
                  app: ml-pipeline-persistenceagent
                  application-crd-id: kubeflow-pipelines
              template:
                metadata:
                  annotations:
                    cluster-autoscaler.kubernetes.io/safe-to-evict: "true"
                  labels:
                    app: ml-pipeline-persistenceagent
                    application-crd-id: kubeflow-pipelines
                spec:
                  affinity:
                    nodeAffinity:
                      requiredDuringSchedulingIgnoredDuringExecution:
                        nodeSelectorTerms:
                        - matchExpressions:
                          - key: system-worker
                            operator: Exists
                    podAntiAffinity:
                      requiredDuringSchedulingIgnoredDuringExecution:
                      - labelSelector:
                          matchExpressions:
                          - key: app
                            operator: In
                            values:
                            - ml-pipeline-persistenceagent
                        topologyKey: kubernetes.io/hostname
                  containers:
                  - env:
                    - name: NAMESPACE
                      valueFrom:
                        fieldRef:
                          fieldPath: metadata.namespace
                    - name: TTL_SECONDS_AFTER_WORKFLOW_FINISH
                      value: "86400"
                    - name: NUM_WORKERS
                      value: "2"
                    image: gcr.io/ml-pipeline/persistenceagent:1.7.0-rc.3
                    imagePullPolicy: IfNotPresent
                    name: ml-pipeline-persistenceagent
                    resources:
                      requests:
                        cpu: 120m
                        memory: 500Mi
                  serviceAccountName: ml-pipeline-persistenceagent
                  tolerations:
                  - effect: NoSchedule
                    key: system
                    operator: Exists
            ---
            apiVersion: apps/v1
            kind: Deployment
            metadata:
              labels:
                app: ml-pipeline-scheduledworkflow
                application-crd-id: kubeflow-pipelines
              name: ml-pipeline-scheduledworkflow
              namespace: kubeflow
            spec:
              replicas: 3
              selector:
                matchLabels:
                  app: ml-pipeline-scheduledworkflow
                  application-crd-id: kubeflow-pipelines
              template:
                metadata:
                  annotations:
                    cluster-autoscaler.kubernetes.io/safe-to-evict: "true"
                  labels:
                    app: ml-pipeline-scheduledworkflow
                    application-crd-id: kubeflow-pipelines
                spec:
                  affinity:
                    nodeAffinity:
                      requiredDuringSchedulingIgnoredDuringExecution:
                        nodeSelectorTerms:
                        - matchExpressions:
                          - key: system-worker
                            operator: Exists
                    podAntiAffinity:
                      requiredDuringSchedulingIgnoredDuringExecution:
                      - labelSelector:
                          matchExpressions:
                          - key: app
                            operator: In
                            values:
                            - ml-pipeline-scheduledworkflow
                        topologyKey: kubernetes.io/hostname
                  containers:
                  - env:
                    - name: NAMESPACE
                      valueFrom:
                        fieldRef:
                          fieldPath: metadata.namespace
                    - name: CRON_SCHEDULE_TIMEZONE
                      valueFrom:
                        configMapKeyRef:
                          key: cronScheduleTimezone
                          name: pipeline-install-config
                    image: gcr.io/ml-pipeline/scheduledworkflow:1.7.0-rc.3
                    imagePullPolicy: IfNotPresent
                    name: ml-pipeline-scheduledworkflow
                  serviceAccountName: ml-pipeline-scheduledworkflow
                  tolerations:
                  - effect: NoSchedule
                    key: system
                    operator: Exists
            ---
            apiVersion: apps/v1
            kind: Deployment
            metadata:
              labels:
                app: ml-pipeline-ui
                application-crd-id: kubeflow-pipelines
              name: ml-pipeline-ui
              namespace: kubeflow
            spec:
              replicas: 3
              selector:
                matchLabels:
                  app: ml-pipeline-ui
                  application-crd-id: kubeflow-pipelines
              template:
                metadata:
                  annotations:
                    cluster-autoscaler.kubernetes.io/safe-to-evict: "true"
                  labels:
                    app: ml-pipeline-ui
                    application-crd-id: kubeflow-pipelines
                spec:
                  affinity:
                    nodeAffinity:
                      requiredDuringSchedulingIgnoredDuringExecution:
                        nodeSelectorTerms:
                        - matchExpressions:
                          - key: system-worker
                            operator: Exists
                    podAntiAffinity:
                      requiredDuringSchedulingIgnoredDuringExecution:
                      - labelSelector:
                          matchExpressions:
                          - key: app
                            operator: In
                            values:
                            - ml-pipeline-ui
                        topologyKey: kubernetes.io/hostname
                  containers:
                  - env:
                    - name: VIEWER_TENSORBOARD_POD_TEMPLATE_SPEC_PATH
                      value: /etc/config/viewer-pod-template.json
                    - name: MINIO_NAMESPACE
                      valueFrom:
                        fieldRef:
                          fieldPath: metadata.namespace
                    - name: MINIO_ACCESS_KEY
                      valueFrom:
                        secretKeyRef:
                          key: accesskey
                          name: mlpipeline-minio-artifact
                    - name: MINIO_SECRET_KEY
                      valueFrom:
                        secretKeyRef:
                          key: secretkey
                          name: mlpipeline-minio-artifact
                    - name: ALLOW_CUSTOM_VISUALIZATIONS
                      value: "true"
                    - name: ARGO_ARCHIVE_LOGS
                      value: "true"
                    - name: ARGO_ARCHIVE_PREFIX
                      value: artifacts
                    image: gcr.io/ml-pipeline/frontend:1.7.0-rc.3
                    imagePullPolicy: IfNotPresent
                    livenessProbe:
                      exec:
                        command:
                        - wget
                        - -q
                        - -S
                        - -O
                        - '-'
                        - http://localhost:3000/apis/v1beta1/healthz
                      initialDelaySeconds: 3
                      periodSeconds: 5
                      timeoutSeconds: 2
                    name: ml-pipeline-ui
                    ports:
                    - containerPort: 3000
                    readinessProbe:
                      exec:
                        command:
                        - wget
                        - -q
                        - -S
                        - -O
                        - '-'
                        - http://localhost:3000/apis/v1beta1/healthz
                      initialDelaySeconds: 3
                      periodSeconds: 5
                      timeoutSeconds: 2
                    resources:
                      requests:
                        cpu: 10m
                        memory: 70Mi
                    volumeMounts:
                    - mountPath: /etc/config
                      name: config-volume
                      readOnly: true
                  serviceAccountName: ml-pipeline-ui
                  tolerations:
                  - effect: NoSchedule
                    key: system
                    operator: Exists
                  volumes:
                  - configMap:
                      name: ml-pipeline-ui-configmap
                    name: config-volume
            ---
            apiVersion: apps/v1
            kind: Deployment
            metadata:
              labels:
                app: ml-pipeline-viewer-crd
                application-crd-id: kubeflow-pipelines
              name: ml-pipeline-viewer-crd
              namespace: kubeflow
            spec:
              replicas: 3
              selector:
                matchLabels:
                  app: ml-pipeline-viewer-crd
                  application-crd-id: kubeflow-pipelines
              template:
                metadata:
                  annotations:
                    cluster-autoscaler.kubernetes.io/safe-to-evict: "true"
                  labels:
                    app: ml-pipeline-viewer-crd
                    application-crd-id: kubeflow-pipelines
                spec:
                  affinity:
                    nodeAffinity:
                      requiredDuringSchedulingIgnoredDuringExecution:
                        nodeSelectorTerms:
                        - matchExpressions:
                          - key: system-worker
                            operator: Exists
                    podAntiAffinity:
                      requiredDuringSchedulingIgnoredDuringExecution:
                      - labelSelector:
                          matchExpressions:
                          - key: app
                            operator: In
                            values:
                            - ml-pipeline-viewer-crd
                        topologyKey: kubernetes.io/hostname
                  containers:
                  - env:
                    - name: MAX_NUM_VIEWERS
                      value: "50"
                    - name: MINIO_NAMESPACE
                      valueFrom:
                        fieldRef:
                          fieldPath: metadata.namespace
                    image: gcr.io/ml-pipeline/viewer-crd-controller:1.7.0-rc.3
                    imagePullPolicy: Always
                    name: ml-pipeline-viewer-crd
                  serviceAccountName: ml-pipeline-viewer-crd-service-account
                  tolerations:
                  - effect: NoSchedule
                    key: system
                    operator: Exists
            ---
            apiVersion: apps/v1
            kind: Deployment
            metadata:
              labels:
                app: ml-pipeline-visualizationserver
                application-crd-id: kubeflow-pipelines
              name: ml-pipeline-visualizationserver
              namespace: kubeflow
            spec:
              replicas: 3
              selector:
                matchLabels:
                  app: ml-pipeline-visualizationserver
                  application-crd-id: kubeflow-pipelines
              template:
                metadata:
                  annotations:
                    cluster-autoscaler.kubernetes.io/safe-to-evict: "true"
                  labels:
                    app: ml-pipeline-visualizationserver
                    application-crd-id: kubeflow-pipelines
                spec:
                  affinity:
                    nodeAffinity:
                      requiredDuringSchedulingIgnoredDuringExecution:
                        nodeSelectorTerms:
                        - matchExpressions:
                          - key: system-worker
                            operator: Exists
                    podAntiAffinity:
                      requiredDuringSchedulingIgnoredDuringExecution:
                      - labelSelector:
                          matchExpressions:
                          - key: app
                            operator: In
                            values:
                            - ml-pipeline-visualizationserver
                        topologyKey: kubernetes.io/hostname
                  containers:
                  - image: gcr.io/ml-pipeline/visualization-server:1.7.0-rc.3
                    imagePullPolicy: IfNotPresent
                    livenessProbe:
                      exec:
                        command:
                        - wget
                        - -q
                        - -S
                        - -O
                        - '-'
                        - http://localhost:8888/
                      initialDelaySeconds: 3
                      periodSeconds: 5
                      timeoutSeconds: 2
                    name: ml-pipeline-visualizationserver
                    ports:
                    - containerPort: 8888
                      name: http
                    readinessProbe:
                      exec:
                        command:
                        - wget
                        - -q
                        - -S
                        - -O
                        - '-'
                        - http://localhost:8888/
                      initialDelaySeconds: 3
                      periodSeconds: 5
                      timeoutSeconds: 2
                    resources:
                      requests:
                        cpu: 30m
                        memory: 500Mi
                  serviceAccountName: ml-pipeline-visualizationserver
                  tolerations:
                  - effect: NoSchedule
                    key: system
                    operator: Exists
            ---
            apiVersion: apps/v1
            kind: Deployment
            metadata:
              labels:
                app: ml-pipeline
                application-crd-id: kubeflow-pipelines
              name: ml-pipeline
              namespace: kubeflow
            spec:
              replicas: 3
              selector:
                matchLabels:
                  app: ml-pipeline
                  application-crd-id: kubeflow-pipelines
              template:
                metadata:
                  annotations:
                    cluster-autoscaler.kubernetes.io/safe-to-evict: "true"
                  labels:
                    app: ml-pipeline
                    application-crd-id: kubeflow-pipelines
                spec:
                  affinity:
                    nodeAffinity:
                      requiredDuringSchedulingIgnoredDuringExecution:
                        nodeSelectorTerms:
                        - matchExpressions:
                          - key: system-worker
                            operator: Exists
                    podAntiAffinity:
                      requiredDuringSchedulingIgnoredDuringExecution:
                      - labelSelector:
                          matchExpressions:
                          - key: app
                            operator: In
                            values:
                            - ml-pipeline
                        topologyKey: kubernetes.io/hostname
                  containers:
                  - env:
                    - name: AUTO_UPDATE_PIPELINE_DEFAULT_VERSION
                      valueFrom:
                        configMapKeyRef:
                          key: autoUpdatePipelineDefaultVersion
                          name: pipeline-install-config
                    - name: POD_NAMESPACE
                      valueFrom:
                        fieldRef:
                          fieldPath: metadata.namespace
                    - name: OBJECTSTORECONFIG_SECURE
                      value: "false"
                    - name: OBJECTSTORECONFIG_BUCKETNAME
                      valueFrom:
                        configMapKeyRef:
                          key: bucketName
                          name: pipeline-install-config
                    - name: DBCONFIG_USER
                      valueFrom:
                        secretKeyRef:
                          key: username
                          name: mysql-secret
                    - name: DBCONFIG_PASSWORD
                      valueFrom:
                        secretKeyRef:
                          key: password
                          name: mysql-secret
                    - name: DBCONFIG_DBNAME
                      valueFrom:
                        configMapKeyRef:
                          key: pipelineDb
                          name: pipeline-install-config
                    - name: DBCONFIG_HOST
                      valueFrom:
                        configMapKeyRef:
                          key: dbHost
                          name: pipeline-install-config
                    - name: DBCONFIG_PORT
                      valueFrom:
                        configMapKeyRef:
                          key: dbPort
                          name: pipeline-install-config
                    - name: DBCONFIG_CONMAXLIFETIMESEC
                      valueFrom:
                        configMapKeyRef:
                          key: ConMaxLifeTimeSec
                          name: pipeline-install-config
                    - name: OBJECTSTORECONFIG_ACCESSKEY
                      valueFrom:
                        secretKeyRef:
                          key: accesskey
                          name: mlpipeline-minio-artifact
                    - name: OBJECTSTORECONFIG_SECRETACCESSKEY
                      valueFrom:
                        secretKeyRef:
                          key: secretkey
                          name: mlpipeline-minio-artifact
                    image: gcr.io/ml-pipeline/api-server:1.7.0-rc.3
                    imagePullPolicy: IfNotPresent
                    livenessProbe:
                      exec:
                        command:
                        - wget
                        - -q
                        - -S
                        - -O
                        - '-'
                        - http://localhost:8888/apis/v1beta1/healthz
                      initialDelaySeconds: 3
                      periodSeconds: 5
                      timeoutSeconds: 2
                    name: ml-pipeline-api-server
                    ports:
                    - containerPort: 8888
                      name: http
                    - containerPort: 8887
                      name: grpc
                    readinessProbe:
                      exec:
                        command:
                        - wget
                        - -q
                        - -S
                        - -O
                        - '-'
                        - http://localhost:8888/apis/v1beta1/healthz
                      initialDelaySeconds: 3
                      periodSeconds: 5
                      timeoutSeconds: 2
                    resources:
                      requests:
                        cpu: 250m
                        memory: 500Mi
                  serviceAccountName: ml-pipeline
                  tolerations:
                  - effect: NoSchedule
                    key: system
                    operator: Exists
            ---
            apiVersion: apps/v1
            kind: Deployment
            metadata:
              labels:
                app: workflow-controller
                application-crd-id: kubeflow-pipelines
              name: workflow-controller
              namespace: kubeflow
            spec:
              replicas: 3
              selector:
                matchLabels:
                  app: workflow-controller
                  application-crd-id: kubeflow-pipelines
              template:
                metadata:
                  labels:
                    app: workflow-controller
                    application-crd-id: kubeflow-pipelines
                spec:
                  affinity:
                    nodeAffinity:
                      requiredDuringSchedulingIgnoredDuringExecution:
                        nodeSelectorTerms:
                        - matchExpressions:
                          - key: system-worker
                            operator: Exists
                    podAntiAffinity:
                      requiredDuringSchedulingIgnoredDuringExecution:
                      - labelSelector:
                          matchExpressions:
                          - key: app
                            operator: In
                            values:
                            - workflow-controller
                        topologyKey: kubernetes.io/hostname
                  containers:
                  - args:
                    - --configmap
                    - workflow-controller-configmap
                    - --executor-image
                    - gcr.io/ml-pipeline/argoexec:v3.1.6-license-compliance
                    - --namespaced
                    command:
                    - workflow-controller
                    env:
                    - name: LEADER_ELECTION_IDENTITY
                      valueFrom:
                        fieldRef:
                          apiVersion: v1
                          fieldPath: metadata.name
                    image: gcr.io/ml-pipeline/workflow-controller:v3.1.6-license-compliance
                    livenessProbe:
                      failureThreshold: 3
                      httpGet:
                        path: /healthz
                        port: 6060
                      initialDelaySeconds: 90
                      periodSeconds: 60
                      timeoutSeconds: 30
                    name: workflow-controller
                    ports:
                    - containerPort: 9090
                      name: metrics
                    - containerPort: 6060
                    resources:
                      requests:
                        cpu: 100m
                        memory: 500Mi
                    securityContext:
                      allowPrivilegeEscalation: false
                      capabilities:
                        drop:
                        - ALL
                      readOnlyRootFilesystem: true
                      runAsNonRoot: true
                  nodeSelector:
                    kubernetes.io/os: linux
                  securityContext:
                    runAsNonRoot: true
                  serviceAccountName: argo
                  tolerations:
                  - effect: NoSchedule
                    key: system
                    operator: Exists
            ---
            apiVersion: extensions/v1beta1
            kind: Ingress
            metadata:
              annotations:
                alb.ingress.kubernetes.io/inbound-cidrs: 0.0.0.0/0
                alb.ingress.kubernetes.io/scheme: internet-facing
                alb.ingress.kubernetes.io/target-type: ip
                kubernetes.io/ingress.class: alb
              name: rest-ingress
              namespace: kubeflow
            spec:
              rules:
              - http:
                  paths:
                  - backend:
                      serviceName: ml-pipeline
                      servicePort: 8888
                    path: /apis/*
                  - backend:
                      serviceName: ml-pipeline-ui
                      servicePort: 80
                    path: /*
            ---
            apiVersion: v1
            kind: PersistentVolumeClaim
            metadata:
              labels:
                application-crd-id: kubeflow-pipelines
              name: minio-pvc
              namespace: kubeflow
            spec:
              accessModes:
              - ReadWriteOnce
              resources:
                requests:
                  storage: 2048Gi


  # workaround - since the ingress never shows the elb below is a hack work around
  JobResource:
    Type: "AWSQS::Kubernetes::Resource"
    Properties:
      ClusterName: !Ref KubeClusterName
      Namespace: kube-system
      Manifest: !Sub |
        apiVersion: batch/v1
        kind: Job
        metadata:
          name: ingress-reset
        spec:
          template:
            spec:
              serviceAccountName: internal-kubectl
              nodeSelector:
                kubernetes.io/os: linux
              containers:
              - name: ingress-reset
                image: bitnami/kubectl:1.18
                command: ["/bin/bash","-c"]
                args:
                  - >
                    sleep 60;
                    while true ; do
                          if [[ -z $(kubectl get ingress rest-ingress -n kubeflow --template="{{range .status.loadBalancer.ingress}}{{.hostname}}{{end}}") ]]; then
                            echo "Re-applying ingress"
                            kubectl -n kubeflow get ingress rest-ingress -oyaml | kubectl -n kubeflow apply -f -;
                          else
                            echo "All good now";
                            exit 0;
                          fi
                          sleep 10;
                    done
              restartPolicy: OnFailure
          backoffLimit: 4